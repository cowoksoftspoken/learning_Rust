<!DOCTYPE html>
<html lang="en" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>RustTube</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        font-family: "Inter", sans-serif;
      }

      .dark body {
        background: #1a202c;
        color: #e2e8f0;
      }

      #progress-fill::after {
        content: attr(data-percent);
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
        color: white;
        font-weight: bold;
        font-size: 0.9em;
      }
    </style>
  </head>

  <body class="min-h-screen flex flex-col items-center justify-center p-4">
    <div
      class="bg-gray-800 dark:bg-gray-900 p-8 rounded-2xl w-full max-w-2xl shadow-lg"
    >
      <h1 class="text-3xl font-bold mb-6 text-gray-100 text-center">
        📥 RustTube Preview
      </h1>

      <!-- Form Login -->
      <form id="login-form" class="flex flex-col gap-4 mb-6">
        <input
          id="username"
          type="text"
          placeholder="Username"
          class="p-3 bg-gray-700 text-gray-100 rounded-lg"
          required
        />
        <button
          type="submit"
          class="py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-semibold transition"
        >
          Login & Dapatkan Token
        </button>
      </form>

      <form id="download-form" class="flex flex-col gap-4 hidden">
        <input
          id="url"
          type="text"
          placeholder="Link YouTube / Tiktok / ..."
          required
          class="p-3 bg-gray-700 text-gray-100 rounded-lg"
        />
        <select id="format" class="p-3 bg-gray-700 text-gray-100 rounded-lg">
          <option value="auto" selected>🤖 Otomatis</option>
          <option value="mp4">🎬 MP4 (Video)</option>
          <option value="mp3">🎵 MP3 (Audio)</option>
        </select>
        <button
          type="submit"
          class="py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition"
        >
          Download
        </button>
      </form>

      <div id="preview-container" class="mt-6 hidden">
        <h2 class="text-lg font-semibold mb-2">Pratinjau Video:</h2>
        <video id="preview-video" class="w-full rounded-lg" controls></video>
      </div>

      <div
        id="progress-container"
        class="mt-6 bg-gray-700 rounded-lg p-4 hidden"
      >
        <div id="progress-text" class="text-md mb-2">⌛ Menunggu...</div>
        <div class="w-full bg-gray-600 rounded-lg h-4 overflow-hidden relative">
          <div
            id="progress-fill"
            class="h-full bg-green-500 rounded-lg transition-all"
            data-percent="0%"
          ></div>
        </div>
        <div id="download-link-container" class="mt-4 hidden">
          <a
            id="download-link"
            href="#"
            target="_blank"
            class="block py-2 bg-green-600 hover:bg-green-700 text-center rounded-lg font-semibold"
          >
            Download File
          </a>
        </div>
      </div>
    </div>
    <script>
      const form = document.getElementById("download-form");
      const progressText = document.getElementById("progress-text");
      const progressFill = document.getElementById("progress-fill");
      const downloadLinkContainer = document.getElementById(
        "download-link-container"
      );
      const loginForm = document.getElementById("login-form");
      const downloadLink = document.getElementById("download-link");
      const videoPreview = document.getElementById("preview-video");
      const previewContainer = document.getElementById("preview-container");
      const progressContainer = document.getElementById("progress-container");

      let currentSource = null;
      let retries = 0;
      const maxRetries = 5;
      let finished = false;
      let token = localStorage.getItem("jwt_access") || "";

      function formatDuration(duration) {
        const minutes = Math.floor(duration / 60);
        const seconds = duration % 60;
        return `${minutes}:${seconds.toString().padStart(2, "0")}`;
      }

      if (token) {
        loginForm.classList.add("hidden");
        form.classList.remove("hidden");
      }

      async function refreshAccessToken() {
        const refreshToken = localStorage.getItem("jwt_refresh");
        if (!refreshToken) {
          alert("Session habis, silakan login ulang");
          localStorage.clear();
          location.reload();
          return null;
        }

        const res = await fetch("/auth/refresh", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ refresh_token: refreshToken }),
        });

        if (!res.ok) {
          alert("Gagal refresh token, silakan login ulang");
          localStorage.clear();
          location.reload();
          return null;
        }

        const data = await res.json();
        localStorage.setItem("jwt_access", data.access_token);
        return data.access_token;
      }

      async function authFetch(url, options = {}) {
        let accessToken = localStorage.getItem("jwt_access");
        if (!options.headers) options.headers = {};
        options.headers.Authorization = `Bearer ${accessToken}`;

        let res = await fetch(url, options);

        if (res.status === 401) {
          accessToken = await refreshAccessToken();
          if (!accessToken) return res;
          options.headers.Authorization = `Bearer ${accessToken}`;
          res = await fetch(url, options);
        }

        return res;
      }

      loginForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const username = document.getElementById("username").value;

        try {
          const res = await fetch("/auth/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username }),
          });

          if (!res.ok) throw new Error("Login gagal!");

          const data = await res.json();
          localStorage.setItem("jwt_access", data.access_token);
          localStorage.setItem("jwt_refresh", data.refresh_token);

          alert("Login sukses! Token JWT disimpan.");
          loginForm.classList.add("hidden");
          form.classList.remove("hidden");
        } catch (err) {
          alert("Gagal login: " + err.message);
        }
      });

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        progressContainer.classList.remove("hidden");
        progressText.textContent = "🚀 Mulai download...";
        progressFill.style.width = "0%";
        progressFill.setAttribute("data-percent", "0%");
        downloadLinkContainer.classList.add("hidden");
        downloadLink.href = "#";
        finished = false;

        const url = document.getElementById("url").value;
        const format = document.getElementById("format").value;

        const formData = new FormData();
        formData.append("url", url);
        formData.append("format", format);

        if (currentSource) {
          currentSource.close();
          currentSource = null;
        }

        try {
          const response = await authFetch("/download", {
            method: "POST",
            body: formData,
          });

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            const errorMsg =
              errorData.status || "Terjadi kesalahan tidak diketahui.";
            progressText.textContent = `Gagal mulai: ${errorMsg}`;
            return;
          }

          const data = await response.json();
          const downloadId = data.id;
          retries = 0;

          connectEventSource(downloadId);
        } catch (error) {
          console.error("[JS] Jaringan error:", error);
          progressText.textContent = `Jaringan error: ${error.message}`;
        }
      });

      function connectEventSource(downloadId) {
        if (currentSource) {
          currentSource.close();
        }

        currentSource = new EventSource(`/progress?id=${downloadId}`);
        console.log(`[JS] Opening EventSource untuk ID: ${downloadId}`);

        currentSource.onmessage = (event) => {
          const msg = event.data.trim();
          console.log("[JS] onmessage:", msg);

          if (msg.startsWith("ERROR:")) {
            finished = true;
            currentSource.close();
            progressText.textContent = `${msg.replace("ERROR:", "")}`;
            return;
          }

          if (msg.startsWith("INFO:")) {
            progressText.textContent = `🔧 ${msg.replace("INFO:", "")}`;
            return;
          }

          const match = msg.match(/(\d+\.\d+)%|(\d+)%/);
          if (match) {
            const percent = parseFloat(match[1] || match[2]);
            progressFill.style.width = `${percent}%`;
            progressFill.setAttribute("data-percent", `${percent.toFixed(0)}%`);
            progressText.textContent = `⏳ Downloading... ${percent.toFixed(
              1
            )}%`;
          }
        };

        currentSource.addEventListener("complete", (event) => {
          finished = true;
          currentSource.close();

          const filename = event.data.trim();
          progressText.textContent = `Selesai: ${filename}`;
          progressFill.style.width = "100%";
          progressFill.setAttribute("data-percent", "100%");
          setDownloadLink(downloadId, filename);
          previewContainer.classList.remove("hidden");
          downloadLink.textContent = `Unduh ${filename} (600s)`;
          downloadLinkContainer.classList.remove("hidden");

          let remaining = 600;
          const timer = setInterval(() => {
            remaining--;
            downloadLink.textContent = `Unduh ${filename} (${formatDuration(
              remaining
            )})`;
            if (remaining <= 0) {
              clearInterval(timer);
              downloadLink.href = "#";
              downloadLink.textContent = `⛔ Link Expired`;
              downloadLink.classList.add("opacity-50", "cursor-not-allowed");
              downloadLink.classList.remove("hover:bg-green-700");
              progressText.textContent =
                "Link download sudah kedaluwarsa. Silakan ulangi.";
              console.log("[Warn] Link expired, tidak bisa diunduh lagi.");
            }
          }, 1000);
        });

        currentSource.onerror = () => {
          if (finished) {
            console.log(
              "[JS] EventSource error tapi udah selesai. Stop reconnect."
            );
            return;
          }

          currentSource.close();

          if (retries < maxRetries) {
            retries++;
            progressText.textContent = `Koneksi terputus... mencoba ulang (${retries}/${maxRetries})`;
            setTimeout(() => connectEventSource(downloadId), 2000);
          } else {
            progressText.textContent = "Gagal menyambung ulang ke server.";
          }
        };
      }

      async function setDownloadLink(downloadId, filename) {
        const fileUrl = `/ambil_download/${downloadId}/${filename}`;
        const res = await authFetch(fileUrl);

        if (!res.ok) {
          throw new Error("Gagal ambil file");
        }

        const blob = await res.blob();
        const blobUrl = URL.createObjectURL(blob);

        videoPreview.src = blobUrl;
        downloadLink.href = blobUrl;
        downloadLink.download = `RustTube_${filename}`;
      }
    </script>
  </body>
</html>
