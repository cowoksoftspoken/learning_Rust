<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RustTube</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        #progress-fill::after {
            content: attr(data-percent);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            color: white;
            font-weight: bold;
            font-size: 0.9em;
        }
    </style>
</head>

<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen p-4">
    <h1 class="text-4xl font-extrabold text-blue-800 mb-8 drop-shadow-lg">ðŸ“¥ RustTube</h1>

    <form id="download-form" class="bg-white p-8 rounded-2xl shadow-xl flex flex-col gap-6 w-full max-w-md">
        <input type="text" id="url" name="url" placeholder="Link YouTube..." required
            class="p-4 border-2 border-gray-300 rounded-xl text-lg focus:border-blue-500 focus:outline-none transition-all duration-300" />

        <!-- ðŸ”½ Dropdown Pilih Format -->
        <select id="format" name="format"
            class="p-4 border-2 border-gray-300 rounded-xl text-lg focus:border-blue-500 focus:outline-none transition-all duration-300">
            <option value="mp4" selected>ðŸŽ¬ MP4 (Video)</option>
            <option value="mp3">ðŸŽµ MP3 (Audio)</option>
        </select>

        <button type="submit"
            class="py-4 px-6 bg-blue-600 text-white font-bold text-xl rounded-xl shadow-lg hover:bg-blue-700 transform hover:scale-105 transition-all duration-300">
            Download
        </button>
    </form>

    <div class="progress-container bg-white p-6 rounded-2xl shadow-xl mt-8 w-full max-w-md text-center overflow-hidden">
        <div id="progress-text" class="text-xl font-semibold text-gray-700 mb-4">âŒ› Menunggu...</div>
        <div id="progress-bar" class="w-full bg-gray-200 rounded-xl h-8 overflow-hidden relative">
            <div id="progress-fill" class="h-full bg-green-500 rounded-xl transition-all duration-300 flex items-center justify-center text-white font-bold text-lg" data-percent="0%"></div>
        </div>
        <div id="download-link-container" class="mt-6 hidden">
            <a id="download-link" href="#" target="_blank"
                class="inline-block py-3 px-6 bg-green-600 text-white font-bold rounded-xl shadow-md hover:bg-green-700 transform hover:scale-105 transition-all duration-300">
                Download File
            </a>
        </div>
    </div>

    <script>
        const form = document.getElementById("download-form");
        const progressText = document.getElementById("progress-text");
        const progressFill = document.getElementById("progress-fill");
        const downloadLinkContainer = document.getElementById("download-link-container");
        const downloadLink = document.getElementById("download-link");

        let currentSource = null;

        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            progressText.textContent = "ðŸš€ Download dimulai...";
            progressFill.style.width = "0%";
            progressFill.setAttribute("data-percent", "0%");
            downloadLinkContainer.classList.add("hidden");
            downloadLink.href = "#";

            const url = document.getElementById("url").value;
            const format = document.getElementById("format").value;

            const formData = new FormData();
            formData.append("url", url);
            formData.append("format", format);

            if (currentSource) {
                currentSource.close();
            }

            try {
                const response = await fetch("/download", {
                    method: "POST",
                    body: formData,
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    const errorMsg = errorData.status || "Terjadi kesalahan yang tidak diketahui.";
                    progressText.textContent = `Gagal start download: ${errorMsg}`;
                    return;
                }

                const responseData = await response.json();
                const downloadId = responseData.id;

                progressText.textContent = `Memulai progres untuk ID: ${downloadId}...`;

                currentSource = new EventSource(`/progress?id=${downloadId}`);

                currentSource.onmessage = (event) => {
                    const text = event.data;
                    progressText.textContent = `Progress: ${text}`;
                    const match = text.match(/(\d+\.\d+)%|(\d+)%/);
                    if (match) {
                        const percent = parseFloat(match[1] || match[2]);
                        progressFill.style.width = percent + "%";
                        progressFill.setAttribute("data-percent", `${percent.toFixed(0)}%`);
                    }
                };

                currentSource.addEventListener("complete", (event) => {
                    const filename = event.data;
                    progressText.textContent = `Download selesai: ${filename}`;
                    progressFill.style.width = "100%";
                    progressFill.setAttribute("data-percent", "100%");

                    downloadLink.href = `/ambil_unduhan/${downloadId}/${filename}`;
                    downloadLink.textContent = `Unduh ${filename}`;
                    downloadLinkContainer.classList.remove("hidden");

                    currentSource.close();
                });

                currentSource.addEventListener("error", (event) => {
                    const errorMsg = event.data || "Terjadi kesalahan saat mengunduh.";
                    progressText.textContent = `Error: ${errorMsg}`;
                    progressFill.style.width = "0%";
                    progressFill.setAttribute("data-percent", "0%");
                    currentSource.close();
                });

            } catch (error) {
                progressText.textContent = `Ada Mistake Jaringan: ${error.message}`;
                progressFill.style.width = "0%";
                progressFill.setAttribute("data-percent", "0%");
                if (currentSource) {
                    currentSource.close();
                }
            }
        });
    </script>
</body>

</html>
